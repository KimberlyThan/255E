---
title: "KimThan_Portfolio"
author: "Kimberly Than"
date: "October 25, 2017"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

Proprioception is the sense of relative body position in space and is necessary for completing complex motor tasks. There are specialized sensors in the muscle that sends information to the brain about muscle length and body position. This information is in the form of action potentials, in which the strength of the stimulus is coded into the frequency of the action potentials that are generated. In our experiments, a specific muscle is isolated and subjected to a series of ramp-and-hold stretches. Through extracellular recording, action potentials of a single neuron is recorded. The raw neural signal is then translated into quantifiable measurement, instantaneous firing frequency, which can be analyzed under different conditions. 

The following code allows us to visualize changes in instantaneous firing frequency under different conditions (doses of glutamate and xanthurenic acid). 

## Download packages

```{r packages, warning = FALSE}
library(knitr)
library(readxl)
library(plyr)
library(dplyr)
library(tidyr)
library(reshape2)
library(ggplot2)
library(RColorBrewer)
```

## Import data

The package 'readxl' was used to read the data from each sheet of my excel workbook. Each sheet contains data for different drugs and drug doses. This package allowed me to get all of the sheet names and put the sheets into a list of data frames, I then separated them into varying data frames named after their respective worksheet name. 

```{r importData}
# Read all sheets and have each worksheet in a list of data frames 
readAllSheets = function(filename) {
    sheets = readxl::excel_sheets(filename)
    x = lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
    names(x) = sheets
    x
}
mySheets = readAllSheets("../data/MasterGlutamateSpreadsheet.xlsx")

# Create an environment containing all list components 
list2env(mySheets, .GlobalEnv)

# Combine all sheets into one data frame 
df = do.call("rbind", mySheets)
str(df)
```

## Including plots for over time data

In the in vitro muscle-nerve experiments, muscles were stretched for a duration of 4 seconds. Instantaneous frequency of the neural firing were recorded at different time points of that ramp-and-hold stretches. Initial Static Time (IST) is the average instantaneous frequency at 0.4 - 0.6 seconds into the stretch. Final Static Time (FST) is the average instantaneous frequency at 3.25 - 3.75 seconds into the stretch. Dynamic Peak (DP) is the highest instantaneous frequency during the ramp up portion of the ramp-and-hold stretch. Dynamic Index (DI) describes the difference in firing between DP and IST. FST, IST, and DP values are included in the excel workbook. 

The graphs below shows the effect of the drug dose in comparison to the control over time.

```{r plotLineGraphFST, warning = FALSE}
##### Plot FST Over Time #####

# Average values in T0 - T17.5 (internal control, baseline) of each row 
df$avgBL = rowMeans(df[ ,11:16], na.rm = TRUE)

# Normalize all values by avgBL as a percent of baseline 
rawNum = df[ ,11:28]
df = transform(df, percentBL = (rawNum/df$avgBL)*100)

# Average each time position (FST, IST, DP) for each dose
dfAvg = df %>%
  group_by(Dose, Position) %>%
  summarise_each(funs(mean(., na.rm = TRUE)))

# Cleaning up the data frame and column names 
avgPercentBL = dfAvg[-c(3:29)]
colnames(avgPercentBL) = gsub('percentBL.T', '', colnames(avgPercentBL), fixed = TRUE)

# Split data frame to include only FST values 
splitPosition = split(avgPercentBL, avgPercentBL$Position)
avgFST = splitPosition$FST

# Transposing the data frame 
avgFST = melt(avgFST)
avgFST$rowID = 1:6

# Plotting FST values over time
ggplot(avgFST, aes(variable, value, group = factor(Dose), color = Dose)) + 
  geom_line() + geom_point() + 
  ggtitle('Changes in average FST over time') +
  xlab('Time (minutes)') + 
  ylab('Instantaneous Firing Frequency (%BL)') +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r plotLineGraphDI, warning = FALSE}
##### plot DI #####

# Calculate DI by taking the difference of DP and IST 
AnNum = unique(df$AnimalNum)

for (i in 1:length(AnNum)){
  tempDP = df[df$AnimalNum == AnNum[i] , ]
  
  DP = tempDP[tempDP$Position == 'DP', 11:28]
  IST = tempDP[tempDP$Position == 'IST', 11:28]
  DI = DP - IST
  
  if (i == 1){
    dfDI = DI
    dfDI$AnimalNumber = AnNum[i]
    dfDI$Dose = as.character(tempDP[1,"Dose"])
  } else {
    DI$AnimalNumber = AnNum[i]
    DI$Dose = as.character(tempDP[1, "Dose"])
    dfDI = rbind(dfDI, DI)
  }
}

# Average values in T0 - T17.5 (internal control, baseline) of each row 
dfDI$avgBL = rowMeans(dfDI[ ,1:6], na.rm = TRUE)

# Normalize all values by avgBL as a percent of baseline 
rawNum2 = dfDI[ ,1:18]
dfDI = transform(dfDI, percentBL = (rawNum2/dfDI$avgBL)*100)

# Average DI for each dose
dfAvgDI = dfDI %>%
  group_by(Dose) %>%
  summarise_each(funs(mean(., na.rm = TRUE)))

# Cleaning up the data frame and column names 
avgDIPercentBL = dfAvgDI[-c(2:21)]
colnames(avgDIPercentBL) = gsub('percentBL.T', '', colnames(avgDIPercentBL), fixed = TRUE)

# Transposing the data frame 
avgDIPercentBL = melt(avgDIPercentBL)
avgDIPercentBL$rowID = 1:6

# Plotting DI values over time
ggplot(avgDIPercentBL, aes(variable, value, group = factor(Dose), color = Dose)) + geom_line() + geom_point() + 
  ggtitle('Changes in average DI over time') +
  xlab('Time (minutes)') + ylab('Instantaneous Firing Frequency (%BL)') +
  theme(plot.title = element_text(hjust = 0.5))
```

## Including scatterplots for peak FST and DI 

Here, I want to plot the maxiumum values of each trial of each dose/condition. I want two graphs, one comparing control to the different 
doses of glutamate and the other comparing to xanthurenic acid. Error bars should be included per dose/condition, as well as different 
colors to show distinuction. 

```{r plotSC, warning = FALSE}
##### Plot FST #####

# Create a data frame with only instantaneous frequency as a percentage of baseline
percentBL = df[-c(1:8, 11:29)]

splitFST = split(percentBL, percentBL$Position)
FSTPercentBL = splitFST$FST

splitGlu = FSTPercentBL[1:24,]

gluPercentBL = splitGlu %>% subset(select = 9:20) %>% mutate(max = do.call(pmax, c(.,na.rm = TRUE))) %>%
  select(max) %>% cbind(splitGlu)

# Subset groups 
gluSC <- gluPercentBL %>% 
  filter(Dose %in% c('Control', '1mM_glu', '3mM_glu'))
# Scatter plot
ggplot(na.omit(gluSC), aes(Dose, as.numeric(max))) +
  geom_jitter(shape = 1, size = 4, position = position_jitter(width = 0.2, height = 0.2)) +
  stat_summary(fun.y = median, fun.ymin = median, fun.ymax = median, geom = "crossbar", width = 0.2, size =1) +
  xlab("") +
  ylab("Instantaneous Frequency (%BL)") +
  ggtitle("Max FST Instantaneous Frequency") +
  theme_minimal(base_size = 16) +
  theme(plot.title = element_text(hjust = 0.5))


splitXA = FSTPercentBL[-c(11:24),]

XAPercentBL = splitXA %>% subset(select = 9:20) %>% mutate(min = do.call(pmin, c(.,na.rm = TRUE))) %>%
  select(min) %>% cbind(splitXA)

# Subset groups 
XASC <- XAPercentBL %>% 
  filter(Dose %in% c('Control', '1mM_XA', '3mM_XA', '10mM_XA'))
# Scatter plot
ggplot(na.omit(XASC), aes(Dose, as.numeric(min))) +
  geom_jitter(shape = 1, size = 4, position = position_jitter(width = 0.2, height = 0.2)) +
  stat_summary(fun.y = median, fun.ymin = median, fun.ymax = median, geom = "crossbar", width = 0.2, size =1) +
  xlab("") +
  ylab("Instantaneous Frequency (%BL)") +
  ggtitle("Max FST Instantaneous Frequency") +
  theme_minimal(base_size = 16) +
  theme(plot.title = element_text(hjust = 0.5))
```

## Statistics 

Maximum changes in FST and compared by condition or responder using a One-Way ANOVA with Tukey HSD. This is used to test the significance between two means.   

```{r Stats, results='asis'}
#GluMax = instFreq2[1:24, 2:3]
#XAMax = instFreq2[-(11:24), 1:3]
#XAMax = XAMax[ ,-(2)]

#anova_Glu = aov(max ~ Dose, data = GluMax)
#summary(anova_Glu)

#anova_XA = aov(min ~ Dose, data = XAMax)
#summary(anova_XA)
```
