---
title: "KimThan_Portfolio"
author: "Kimberly Than"
date: "October 25, 2017"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Download packages

```{r packages}
# 'readxl' 
library(readxl)

# 'plyr'
library(plyr)

# 'dplyr'
library(dplyr)

# 'tidyr
library(tidyr)

# 'reshape2'
library(reshape2)

# 'ggplot2'
library(ggplot2)
```

## Import data

The package 'readxl' was used to read the data from each sheet of my excel workbook. Each sheet contains data for different drugs and drug doses. This package allowed me to get all of the sheet names and put the sheets into a list of data frames, I then separated them into varying data frames named after their respective worksheet name. 

```{r importData}
# Read all sheets and have each worksheet in a list of data frames 
readAllSheets = function(filename) {
    sheets = readxl::excel_sheets(filename)
    x = lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
    names(x) = sheets
    x
}
mySheets = readAllSheets("../data/MasterGlutamateSpreadsheet.xlsx")

# Create an environment containing all list components 
list2env(mySheets, .GlobalEnv)

# Combine all sheets into one data frame 
df = do.call("rbind", mySheets)

```

## Including plots for over time data

In the in vitro muscle-nerve experiments, muscles were stretched for a duration of 4 seconds. Instantaneous frequency of the neural firing were recorded at different time points of that ramp-and-hold stretches. Initial Static Time (IST) is the average instantaneous frequency at 0.4 - 0.6 seconds into the stretch. Final Static Time (FST) is the average instantaneous frequency at 3.75 - 3.75 seconds into the stretch. Dynamic Peak (DP) is the highest instantaneous frequency during the ramp up portion of the ramp-and-hold stretch. Dynamic Index (DI) describes the difference in firing between DP and IST. FST, IST, and DP values are included in the excel workbook. 

The graphs below shows the effect of the drug dose in comparison to the control over time.

```{r plotLineGraphs}
##### Plot FST Over Time #####

# Average values in T0 - T17.5 (internal control, baseline) of each row 
df$avgBL = rowMeans(df[ ,11:16], na.rm = TRUE)

# Normalize all values by avgBL as a percent of baseline 
rawNum = df[ ,11:28]
df = transform(df, percentBL = (rawNum/df$avgBL)*100)

# Average each time position (FST, IST, DP) for each dose
dfAvg = df %>%
  group_by(Dose, Position) %>%
  summarise_each(funs(mean(., na.rm = TRUE)))

# Cleaning up the data frame and column names 
avgPercentBL = dfAvg[-c(3:29)]
colnames(avgPercentBL) = gsub('percentBL.T', '', colnames(avgPercentBL), fixed = TRUE)

# Split data frame to include only FST values 
splitPosition = split(avgPercentBL, avgPercentBL$Position)
avgFST = splitPosition$FST

# Transposing the data frame 
avgFST = melt(avgFST)
avgFST$rowID = 1:6

# Plotting FST values over time
ggplot(avgFST, aes(variable, value, group = factor(Dose), color = Dose)) + geom_line() + geom_point() + 
  ggtitle('Changes in average FST over time') +
  xlab('Time (minutes)') + ylab('Instantaneous Firing Frequency (%BL)') +
  theme(plot.title = element_text(hjust = 0.5))

##### plot DI #####

# Calculate DI by taking the difference of DP and IST 
AnNum = unique(df$AnimalNum)

for (i in 1:length(AnNum)){
  tempDP = df[df$AnimalNum == AnNum[i] , ]
  
  DP = tempDP[tempDP$Position == 'DP', 11:28]
  IST = tempDP[tempDP$Position == 'IST', 11:28]
  DI = DP - IST
  
  if (i == 1){
    dfDI = DI
    dfDI$AnimalNumber = AnNum[i]
  } else {
    DI$AnimalNumber = AnNum[i]
    dfDI = rbind(dfDI, DI)
  }
}

# Average values in T0 - T17.5 (internal control, baseline) of each row 
dfDI$avgBL = rowMeans(dfDI[ ,1:6], na.rm = TRUE)

# Normalize all values by avgBL as a percent of baseline 
rawNum2 = dfDI[ ,1:18]
dfDI = transform(dfDI, percentBL = (rawNum/dfDI$avgBL)*100)

DIControl = dfDI[1:10,]
DIGlu1mM = dfDI[11:22,]
DIGlu3mM = dfDI[23:24,]
DIXA1mM = dfDI[25:33,]
DIXA3mM = dfDI[34:50,]
DIXA10mM = dfDI[51:56,]

DIControl = DIControl %>% summarise_each(funs(mean))
DIGlu1mM = DIGlu1mM %>% summarise_each(funs(mean))
DIGlu3mM = DIGlu3mM %>% summarise_each(funs(mean))
DIXA1mM = DIXA1mM %>% summarise_each(funs(mean))
DIXA3mM = DIXA3mM %>% summarise_each(funs(mean))
DIXA10mM = DIXA10mM %>% summarise_each(funs(mean))

DIControl = DIControl[-c(1:20)]
DIGlu1mM = DIGlu1mM[-c(1:20)]
DIGlu3mM = DIGlu3mM[-c(1:20)]
DIXA1mM = DIXA1mM[-c(1:20)]
DIXA3mM = DIXA3mM[-c(1:20)]
DIXA10mM = DIXA10mM[-c(1:20)]

colnames(DIControl) = gsub('percentBL.T', '', colnames(DIControl), fixed = TRUE)
colnames(DIGlu1mM) = gsub('percentBL.T', '', colnames(DIGlu1mM), fixed = TRUE)
colnames(DIGlu3mM) = gsub('percentBL.T', '', colnames(DIGlu3mM), fixed = TRUE)
colnames(DIXA1mM) = gsub('percentBL.T', '', colnames(DIXA1mM), fixed = TRUE)
colnames(DIXA3mM) = gsub('percentBL.T', '', colnames(DIXA3mM), fixed = TRUE)
colnames(DIXA10mM) = gsub('percentBL.T', '', colnames(DIXA10mM), fixed = TRUE)

avgDI = rbind(DIControl, DIGlu1mM, DIXA1mM, DIXA3mM, DIXA10mM)

avgDI = melt(avgDI)
avgDI$rowID = 1:5

ggplot(avgDI, aes(variable, value, group = factor(rowID), color = rowID)) + geom_line() + geom_point() + 
  ggtitle('Changes in average DI over time') +
  xlab('Time (minutes)') + ylab('Instantaneous Firing Frequency (%BL)') +
  theme(plot.title = element_text(hjust = 0.5))
```


## Including scatterplots for peak FST and DI 

Here, I want to plot the maxiumum values of each trial of each dose/condition. I want two graphs, one comparing control to the different 
doses of glutamate and the other comparing to xanthurenic acid. Error bars should be included per dose/condition, as well as different 
colors to show distinuction. 

```{r plotSC}
##### Plot FST #####

instFreq = df[-c(1:8, 11:29)]

splitPosition2 = split(instFreq, instFreq$Position)
instFreq2 = splitPosition2$FST

instFreq2 = instFreq2 %>% subset(select = 3:20) %>% mutate(mak = do.call(pmax, (.))) %>%
  select(mak) %>% cbind(instFreq2)

# subset groups 1 & 2
SC <- instFreq2 %>% 
  filter(Dose %in% c('Control', '1mM_glu', '3mM_glu', '1mM_XA', '3mM_XA', '10mM_XA'))
# plot
ggplot(SC, aes(Dose, as.numeric(mak))) +
  geom_point(shape = 1, size = 6) +
  stat_summary(fun.y = median, fun.ymin = median, fun.ymax = median, geom = "crossbar", width = 0.2, size =1) +
  xlab("") +
    ylab("Instantaneous Frequency (%BL)") +
  ggtitle("Max FST Instantaneous Frequency")
  theme_minimal(base_size = 16) 
```

## Statistics 

TENTATIVE
Maximum changes in FST and DI compared by condition or responder using a One-Way ANOVA with Dunnett post-hoc. Average over time analyses were compared using a repeated measure with time as the within-subjects variable and condition as the between-subjects factor with Tukey post-hoc.  

